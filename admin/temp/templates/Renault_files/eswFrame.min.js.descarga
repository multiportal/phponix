(function(){function c(){this.parentOrigin=void 0;this.messageHandlers={};this.featureScripts={};this.sessionLoaded=!1;this.pendingMessages={};this.availableFeatures=["script"];window.location.search.replace(/([a-zA-Z0-9]+)=([\S]+)/g,function(a,b,d){"parent"===b&&(this.parentOrigin=d)}.bind(this));this.parentOrigin?(this.addEventListeners(),this.loadFeatureScript("Session"),this.loadFeatureScript("Broadcast"),this.addMessageHandler("script.load",function(a,b){this.loadFeatureScript(b)}.bind(this)),
this.addMessageHandler("session.updateStorage",function(a,b){var d=b.deploymentId,e=JSON.parse(esw.sessionAPI.getSessionData(a,["ACTIVE_CHAT_SESSIONS"],!0).ACTIVE_CHAT_SESSIONS||"{}"),c=!1,g=!1,f=(this.isInternetExplorer()||this.isEdge())&&1===history.length&&!b.isRefresh;esw.sessionAPI.getSessionData(a,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===d&&(b.isSamePageNavigation&&!f?c=!0:esw.sessionAPI.deleteSessionData(a,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]));esw.broadcastAPI.on("sessionStorageData",
function(b){var d=JSON.parse(b.sessionStorage);this.sessionLoaded||b.domain!==a||(g=!0,Object.getOwnPropertyNames(d).forEach(function(a){-1===a.indexOf("MASTER_DEPLOYMENT_ID")&&sessionStorage.setItem(a,d[a])}),this.sessionLoaded=!0,parent.postMessage({method:"session.onLoad"},this.parentOrigin))}.bind(this));esw.broadcastAPI.on("getSessionStorageData",function(b){b.domain===a&&(c||esw.sessionAPI.getSessionData(a,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===b.deploymentId)&&esw.broadcastAPI.send("sessionStorageData",
{sessionStorage:JSON.stringify(sessionStorage),domain:a})});e[b.deploymentId]&&!c?(esw.broadcastAPI.send("getSessionStorageData",{deploymentId:b.deploymentId,domain:a}),setTimeout(function(){g||(this.sessionLoaded=!0,delete e[b.deploymentId],esw.sessionAPI.setSessionData(a,{ACTIVE_CHAT_SESSIONS:JSON.stringify(e)},!0),parent.postMessage({method:"session.onLoad"},this.parentOrigin))}.bind(this),500)):parent.postMessage({method:"session.onLoad"},this.parentOrigin)}.bind(this))):console.error("No domain set!")}
var f=["broadcast","chasitor","filetransfer","session"];c.prototype.isInternetExplorer=function(){return"ActiveXObject"in window};c.prototype.isEdge=function(){return window.navigator&&window.navigator.userAgent&&"string"===typeof window.navigator.userAgent?-1<window.navigator.userAgent.indexOf("Edge"):!1};c.prototype.log=function(a){window.devMode&&console.log(a)};c.prototype.getSafariType=function(){var a=navigator.userAgent.toLowerCase(),b=!window.safari,d="ontouchend"in document;return-1===a.indexOf("chrome")&&
-1!==a.indexOf("safari")?b&&d?"mobile":"desktop":"none"};c.prototype.addMessageHandler=function(a,b){this.messageHandlers[a]=b};c.prototype.addEventListeners=function(){window.addEventListener("message",function(a){var b=a.data;if(b&&b.method){var d=a.origin.indexOf("://")+3;var c=a.origin.substring(d);c=c.split(":")[0];(d=b.domain)&&".force.com"===c.substr(-10)&&(d=d.split("/")[0]);a.origin!==window.esw.parentOrigin.substr(0,a.origin.length)?console.log("Message origin must match parent origin!"):
c!==d&&-1===c.indexOf("."+d,c.length-d.length-1)?console.log("storageDomain ("+b.domain+") must be a parent of message origin domain ("+c+")!"):(a=b.method.split(".")[0].toLowerCase(),-1===this.availableFeatures.indexOf(a)?(this.pendingMessages[a]||(this.pendingMessages[a]=[]),this.pendingMessages[a].push(b)):this.handleMessage(b))}}.bind(this),!1)};c.prototype.handleMessage=function(a){if(this.messageHandlers[a.method])this.messageHandlers[a.method](a.domain,a.data);else console.log("Unregistered method "+
a.method+" received in frame.")};c.prototype.defineFeature=function(a,b){this.featureScripts[a]=b};c.prototype.loadFeatureScript=function(a,b){var c=a.toLowerCase();if(-1<f.indexOf(c)){var e=document.createElement("script");e.type="text/javascript";e.src="frame/"+c+".esw"+(window.devMode?"":".min")+".js";e.onload=function(){this.featureScripts[a](this);b&&b();this.availableFeatures.push(c);this.processPendingMessages(c)}.bind(this);document.body.appendChild(e)}else throw Error('"'+a+'" is not a valid feature name.');
};c.prototype.postMessage=function(a,b){parent.postMessage({method:a,data:b},this.parentOrigin)};c.prototype.processPendingMessages=function(a){this.pendingMessages[a]&&(this.pendingMessages[a].forEach(function(a){this.handleMessage(a)}.bind(this)),this.pendingMessages[a]=void 0)};window.esw=new c})();
